---
// Fallback bars rendered at build time — replaced dynamically by API milestones
const fallbackBars = [
  { label: 'S5', value: '3.2', pct: 38, opacity: '20' },
  { label: 'S10', value: '2.5', pct: 54, opacity: '30' },
  { label: 'S20', value: '1.8', pct: 72, opacity: '50' },
  { label: 'S28', value: '1.2', pct: 92, opacity: '' },
];
---

<section id="proof" class="py-24 sm:py-32">
  <div class="max-w-4xl mx-auto px-6">
    <!-- Section header -->
    <div class="text-center mb-12" data-reveal>
      <p class="text-emerald text-xs font-mono uppercase tracking-widest mb-3">It Works</p>
      <h2 class="font-heading font-bold text-3xl sm:text-4xl mb-4">
        Consistent routines compound.
      </h2>
    </div>

    <!-- Trend timeline -->
    <div class="rounded-xl border border-border bg-bg-card p-6 sm:p-8 mb-10" data-reveal>
      <div class="flex items-center gap-2 mb-6">
        <span class="w-2 h-2 rounded-full bg-emerald animate-pulse"></span>
        <span class="text-text-muted text-xs font-mono uppercase tracking-wider">Performance Trajectory</span>
      </div>

      <!-- Bar chart — dynamic container -->
      <div id="proof-bars" class="grid gap-3 sm:gap-6 mb-6" aria-live="polite" style="grid-template-columns: repeat(4, 1fr);">
        {fallbackBars.map(({ label, value, pct, opacity }) => (
          <div class="proof-bar flex flex-col items-center">
            <div class="h-24 sm:h-32 w-full flex items-end">
              <div
                class={`w-full rounded-t-md ${opacity ? `bg-emerald/${opacity}` : 'bg-emerald'}`}
                data-bar-fill
                style={`height: ${pct}%`}
              />
            </div>
            <div class="text-center pt-2">
              <div class="font-mono text-xs text-text-muted" data-bar-label>{label}</div>
              <div class={`font-heading font-bold text-sm ${opacity ? 'text-text-secondary' : 'text-emerald'}`} data-bar-value>{value}</div>
            </div>
          </div>
        ))}
      </div>

      <div class="text-center text-text-muted text-xs font-mono">
        Lower is better — rolling performance average over <span id="proof-sprint-count" class="text-emerald">28</span> sprints
      </div>
    </div>

    <!-- Anecdote -->
    <div class="text-center max-w-2xl mx-auto" data-reveal>
      <p class="text-text-secondary leading-relaxed mb-4">
        In Sprint 12, the same bug appeared for the third time. SLOPE flagged it as a recurring hazard. It never appeared again.
      </p>
      <p class="text-text-muted text-sm italic">
        Every metric on this page comes from the reference implementation — <span id="proof-sprint-total" class="text-emerald">28</span> sprints of real work.
      </p>
    </div>
  </div>
</section>

<script>
  import { onStatsUpdate } from '../scripts/live-stats';
  import { animateCounter } from '../scripts/animations';

  const countEl = document.getElementById('proof-sprint-count');
  const totalEl = document.getElementById('proof-sprint-total');
  const barsContainer = document.getElementById('proof-bars');

  function renderBars(milestones: Array<{ sprint: number; handicap: number }>) {
    if (!barsContainer || milestones.length === 0) return;

    // Find max handicap for percentage scaling (inverted: lower = taller)
    const maxHandicap = Math.max(...milestones.map((m) => m.handicap), 4);

    // Determine opacity steps: oldest = most transparent, newest = full
    const opacitySteps = ['20', '30', '40', '50', ''];
    function getOpacity(index: number, total: number): string {
      if (total <= 1) return '';
      if (index === total - 1) return ''; // newest = full opacity
      const step = Math.floor((index / (total - 1)) * (opacitySteps.length - 1));
      return opacitySteps[Math.min(step, opacitySteps.length - 2)];
    }

    // Update grid columns to match milestone count
    barsContainer.style.gridTemplateColumns = `repeat(${milestones.length}, 1fr)`;

    // Build new bar HTML
    barsContainer.innerHTML = milestones
      .map((m, i) => {
        const pct = Math.round(((maxHandicap - m.handicap) / maxHandicap) * 100);
        const opacity = getOpacity(i, milestones.length);
        const isLatest = i === milestones.length - 1;
        const bgClass = opacity ? `bg-emerald/${opacity}` : 'bg-emerald';
        const textClass = isLatest ? 'text-emerald' : 'text-text-secondary';

        return `
          <div class="proof-bar flex flex-col items-center">
            <div class="h-24 sm:h-32 w-full flex items-end">
              <div class="w-full rounded-t-md ${bgClass}" style="height: ${pct}%"></div>
            </div>
            <div class="text-center pt-2">
              <div class="font-mono text-xs text-text-muted">S${m.sprint}</div>
              <div class="font-heading font-bold text-sm ${textClass}">${m.handicap.toFixed(1)}</div>
            </div>
          </div>
        `;
      })
      .join('');
  }

  onStatsUpdate((stats) => {
    if (countEl) animateCounter(countEl, stats.sprints_completed);
    if (totalEl) animateCounter(totalEl, stats.sprints_completed);

    // Update bars from API milestones
    if (stats.handicap_milestones && stats.handicap_milestones.length > 0) {
      renderBars(stats.handicap_milestones);
    }
  });
</script>
